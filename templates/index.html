<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒæ¬¡å…ƒç»˜å›¾æœº v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .active-tab { background: #6366f1; color: white; }
        .loader { border: 3px solid #334155; border-top-color: #818cf8; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        /* éšè—æ»šåŠ¨æ¡ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        select { background: #1e293b; color: white; padding: 5px; border-radius: 5px; border: 1px solid #334155; outline: none; }
    </style>
</head>
<body class="min-h-screen flex justify-center p-4">
    <div class="max-w-md w-full space-y-4">
        <!-- å¤´éƒ¨ -->
        <header class="flex justify-between items-center py-2">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-indigo-600 rounded-lg shadow-lg"><i data-lucide="zap" class="text-white w-5 h-5"></i></div>
                <h1 class="font-bold text-lg">Anime AI <span class="text-xs bg-indigo-500/20 text-indigo-300 px-1 rounded">PRO</span></h1>
            </div>
            <div class="flex flex-col items-end gap-1">
                <select id="providerSelect" onchange="toggleKey()">
                    <option value="guest" selected>ğŸ æ¸¸å®¢å…è´¹æ¨¡å¼ (ç¨³)</option>
                    <option value="google">â˜ï¸ Google Gemini</option>
                    <option value="openai">ğŸ¤– OpenAI DALL-E</option>
                </select>
                <input id="userKey" type="password" class="hidden w-32 bg-slate-800 border border-slate-700 text-[10px] rounded px-2 py-1 outline-none text-right" placeholder="è¾“å…¥ Key">
            </div>
        </header>

        <!-- æ¨¡å¼ -->
        <div class="flex bg-slate-800/80 p-1 rounded-xl overflow-x-auto no-scrollbar">
            <button onclick="setMode('txt2img')" id="btn-txt2img" class="flex-1 py-2 text-xs font-bold rounded-lg active-tab transition-all min-w-[70px]">ç»˜å›¾</button>
            <button onclick="setMode('colorize')" id="btn-colorize" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 transition-all min-w-[70px]">ä¸Šè‰²</button>
            <button onclick="setMode('lineart')" id="btn-lineart" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 transition-all min-w-[70px]">çº¿ç¨¿</button>
        </div>

        <!-- ä¸Šä¼ åŒº -->
        <div id="uploadArea" class="hidden glass p-4 rounded-2xl border-dashed border-2 border-slate-600/50">
            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFile(this)">
            <div id="uploadPlaceholder" onclick="document.getElementById('fileInput').click()" class="flex flex-col items-center justify-center h-20 text-slate-400 cursor-pointer">
                <i data-lucide="image-plus" class="mb-2"></i><span class="text-xs">ç‚¹å‡»ä¸Šä¼ åº•å›¾</span>
            </div>
            <div id="previewBox" class="hidden relative"><img id="previewImg" class="h-32 w-full object-contain rounded-lg"><button onclick="clearFile()" class="absolute top-1 right-1 bg-black/60 text-white p-1 rounded-full"><i data-lucide="x" class="w-3 h-3"></i></button></div>
        </div>

        <!-- è¾“å…¥æ¡† -->
        <textarea id="prompt" class="glass w-full h-24 p-3 rounded-2xl bg-transparent resize-none text-sm outline-none placeholder-slate-500" placeholder="æè¿°ç”»é¢..."></textarea>

        <!-- æŒ‰é’® -->
        <button onclick="generate()" id="genBtn" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2"><i data-lucide="play" class="w-4 h-4 fill-current"></i> å¼€å§‹ç”Ÿæˆ</button>

        <!-- ç»“æœ -->
        <div id="resultBox" class="glass rounded-2xl min-h-[300px] flex items-center justify-center relative bg-slate-900/50 overflow-hidden">
            <div id="loader" class="hidden flex flex-col items-center"><div class="loader mb-2"></div><span class="text-xs text-indigo-400 animate-pulse">AI ç»˜åˆ¶ä¸­...</span></div>
            <img id="resultImg" class="hidden w-full h-full object-contain shadow-2xl relative z-10" onload="this.style.opacity=1">
            <button id="dlBtn" onclick="downloadImg()" class="hidden absolute bottom-4 bg-white text-slate-900 px-6 py-2 rounded-full font-bold text-xs shadow-xl z-20">ä¿å­˜</button>
        </div>
    </div>

    <script>
        let state = { mode: 'txt2img', image: null };
        function init() { lucide.createIcons(); }
        function toggleKey() { document.getElementById('userKey').classList.toggle('hidden', document.getElementById('providerSelect').value === 'guest'); }
        
        function setMode(m) {
            state.mode = m;
            document.querySelectorAll('button[id^="btn-"]').forEach(b => { b.classList.remove('active-tab', 'text-white'); b.classList.add('text-slate-400'); });
            document.getElementById('btn-' + m).classList.add('active-tab', 'text-white');
            document.getElementById('btn-' + m).classList.remove('text-slate-400');
            document.getElementById('uploadArea').classList.toggle('hidden', m === 'txt2img');
        }

        function handleFile(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { state.image = e.target.result.split(',')[1]; document.getElementById('previewImg').src = e.target.result; document.getElementById('uploadPlaceholder').classList.add('hidden'); document.getElementById('previewBox').classList.remove('hidden'); };
            reader.readAsDataURL(file);
        }
        function clearFile() { state.image = null; document.getElementById('uploadPlaceholder').classList.remove('hidden'); document.getElementById('previewBox').classList.add('hidden'); document.getElementById('fileInput').value = ''; }

        async function generate() {
            const prompt = document.getElementById('prompt').value.trim();
            const provider = document.getElementById('providerSelect').value;
            const userKey = document.getElementById('userKey').value.trim();
            if (state.mode !== 'txt2img' && !state.image) return alert("è¯·å…ˆä¸Šä¼ åº•å›¾");

            const btn = document.getElementById('genBtn'); btn.disabled = true; btn.classList.add('opacity-50');
            document.getElementById('loader').classList.remove('hidden'); document.getElementById('resultImg').classList.add('hidden'); document.getElementById('dlBtn').classList.add('hidden');

            try {
                const res = await fetch('/api/generate', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, mode: state.mode, prompt, image: state.image, api_key: userKey })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                const img = document.getElementById('resultImg');
                img.src = data.image_url ? data.image_url : "data:image/png;base64," + data.image_b64;
                img.onload = () => { img.classList.remove('hidden'); document.getElementById('dlBtn').classList.remove('hidden'); document.getElementById('loader').classList.add('hidden'); };
            } catch (e) { alert(e.message); document.getElementById('loader').classList.add('hidden'); } 
            finally { btn.disabled = false; btn.classList.remove('opacity-50'); }
        }
        function downloadImg() { const a = document.createElement('a'); a.href = document.getElementById('resultImg').src; a.download = `anime-${Date.now()}.png`; a.click(); }
        init();
    </script>
</body>
</html>


