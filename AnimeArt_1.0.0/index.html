<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒæ¬¡å…ƒç»˜å›¾æœº 1.0.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass-panel { background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
        .mode-tab.active { background-color: #4f46e5; color: white; border-color: #6366f1; }
        .style-card.active { background: linear-gradient(135deg, rgba(79, 70, 229, 0.2), rgba(124, 58, 237, 0.1)); border-color: #818cf8; }
        .cyber-loader { width: 40px; height: 40px; border: 3px solid #334155; border-top-color: #818cf8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #authModal { transition: opacity 0.3s, transform 0.3s; }
        #authModal.hidden-modal { opacity: 0; pointer-events: none; transform: scale(1.1); }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-appearance: none; appearance: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-3 md:p-6 pb-24">

    <!-- 1. å¯åŠ¨é…ç½®é®ç½© -->
    <div id="authModal" class="fixed inset-0 z-[100] bg-[#0f172a] flex flex-col items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm p-8 rounded-3xl border border-indigo-500/30 shadow-2xl relative">
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-600/20">
                    <i data-lucide="power" class="text-white w-7 h-7"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">é…ç½®å¼•æ“</h2>
                <p class="text-slate-400 text-xs mt-1">äºŒæ¬¡å…ƒç»˜å›¾æœº v1.0.0</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-indigo-300 ml-1">æ¨¡å‹æä¾›å•† (Provider)</label>
                    <select id="providerSelect" onchange="toggleAuthFields()" class="w-full bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl outline-none mt-1 focus:border-indigo-500 transition-colors">
                        <option value="guest" selected>ğŸ æœ¬åœ°æ¸¸å®¢æ¨¡å¼ (å…Key)</option>
                        <option value="openai">ğŸ¤– OpenAI (DALL-E)</option>
                        <option value="chatgpt">ğŸ’¬ ChatGPT (API)</option>
                        <option value="qwen">ğŸ‰ é˜¿é‡Œåƒé—® (Aliyun)</option>
                        <option value="doubao">ğŸŒ‹ ç«å±±å¼•æ“ (è±†åŒ…)</option>
                    </select>
                </div>

                <div id="keyField" class="hidden">
                    <label class="text-xs font-bold text-indigo-300 ml-1">API Key (å¯†é’¥)</label>
                    <input type="password" id="apiKeyInput" class="w-full bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl outline-none mt-1 font-mono text-center tracking-wider focus:border-indigo-500 transition-colors" placeholder="sk-..." />
                </div>

                <div id="guestHint" class="text-[11px] text-slate-400 bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 leading-relaxed">
                    <span class="text-indigo-400 font-bold">â„¹ï¸ è¯´æ˜ï¼š</span> æ¸¸å®¢æ¨¡å¼ä½¿ç”¨çš„æ˜¯ä»£ç å†…ç½®å¯†é’¥ã€‚
                </div>

                <div id="loginError" class="hidden text-xs text-red-400 text-center bg-red-500/10 p-2 rounded-lg border border-red-500/20"></div>
            </div>

            <button onclick="saveAuthAndStart()" id="launchBtn" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-500/25 active:scale-95 transition-all">
                ç«‹å³å¯åŠ¨
            </button>
        </div>
    </div>

    <!-- 2. ç•Œé¢ä¸»ä½“ (çœç•¥é‡å¤ç»“æ„ï¼Œä¿æŒä¸å˜) -->
    <header class="max-w-4xl mx-auto w-full flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                <i data-lucide="zap" class="text-white w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-white tracking-tight leading-none">äºŒæ¬¡å…ƒç»˜å›¾æœº <span class="text-indigo-400">1.0.0</span></h1>
                <p class="text-[10px] text-slate-400 font-mono mt-0.5" id="engineBadge">Engine: Guest</p>
            </div>
        </div>
        <button onclick="openSettings()" class="p-2 bg-slate-800/50 rounded-lg text-slate-400 hover:text-white border border-slate-700 hover:bg-slate-800 transition-colors">
            <i data-lucide="settings-2" class="w-5 h-5"></i>
        </button>
    </header>

    <div class="max-w-4xl mx-auto w-full mb-4 overflow-x-auto no-scrollbar">
        <div class="flex gap-2 min-w-max">
            <button onclick="switchMode('txt2img')" id="tab-txt2img" class="mode-tab active px-4 py-2 rounded-xl bg-slate-800 text-slate-400 text-xs font-bold flex items-center gap-2 border border-transparent">çµæ„Ÿç»˜å›¾</button>
            <button onclick="switchMode('lineart')" id="tab-lineart" class="mode-tab px-4 py-2 rounded-xl bg-slate-800 text-slate-400 text-xs font-bold flex items-center gap-2 border border-transparent">çº¿ç¨¿æå–</button>
            <button onclick="switchMode('colorize')" id="tab-colorize" class="mode-tab px-4 py-2 rounded-xl bg-slate-800 text-slate-400 text-xs font-bold flex items-center gap-2 border border-transparent">è‡ªåŠ¨ä¸Šè‰²</button>
            <button onclick="switchMode('redraw')" id="tab-redraw" class="mode-tab px-4 py-2 rounded-xl bg-slate-800 text-slate-400 text-xs font-bold flex items-center gap-2 border border-transparent">é£æ ¼é‡ç»˜</button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto w-full flex flex-col lg:flex-row gap-4">
        <aside class="w-full lg:w-1/3 flex flex-col gap-4">
            <div class="glass-panel p-4 rounded-2xl">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 block">ç”»é£é¢„è®¾</label>
                <div class="grid grid-cols-2 gap-2" id="styleGrid"></div>
            </div>
            <div id="uploadCard" class="glass-panel p-4 rounded-2xl hidden">
                <div class="flex justify-between items-center mb-3">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">å‚è€ƒå›¾</label>
                    <span class="text-[10px] bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded">å¿…é€‰</span>
                </div>
                <div class="relative group">
                    <input type="file" id="imageInput" class="hidden" accept="image/*" />
                    <div id="uploadBox" class="h-32 border-2 border-dashed border-slate-700 hover:border-indigo-500 hover:bg-slate-800/30 rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all" onclick="document.getElementById('imageInput').click()">
                        <i data-lucide="image-plus" class="text-slate-400 w-6 h-6 mb-2"></i>
                    </div>
                    <div id="previewBox" class="hidden relative h-40 bg-slate-900 rounded-xl overflow-hidden border border-slate-700">
                        <img id="previewImg" class="w-full h-full object-contain opacity-80" />
                        <button onclick="clearImage(event)" class="absolute top-2 right-2 bg-black/60 hover:bg-red-500/80 text-white p-1.5 rounded-lg backdrop-blur-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
        </aside>
        <main class="w-full lg:w-2/3 flex flex-col gap-4">
            <div class="glass-panel p-3 rounded-2xl relative">
                <textarea id="promptInput" class="w-full h-24 bg-transparent text-sm resize-none outline-none placeholder-slate-600 text-slate-200 p-1" placeholder="åœ¨æ­¤è¾“å…¥æè¿°..."></textarea>
                <div class="absolute bottom-3 right-3">
                    <button onclick="optimizePrompt()" id="magicBtn" class="text-xs bg-indigo-500/10 text-indigo-400 px-3 py-1.5 rounded-lg hover:bg-indigo-500/20 flex items-center gap-1 border border-indigo-500/20 transition-all active:scale-95">
                        <i data-lucide="sparkles" class="w-3 h-3"></i> ä¼˜åŒ–
                    </button>
                </div>
            </div>
            <button onclick="startGenerate()" id="genBtn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-900/30 flex items-center justify-center gap-2 active:scale-95 transition-all">
                <i data-lucide="play" class="w-5 h-5 fill-current"></i> å¼€å§‹ç”Ÿæˆ
            </button>
            <div id="outputArea" class="glass-panel rounded-2xl min-h-[350px] flex items-center justify-center relative overflow-hidden bg-slate-900/30 border-dashed border-2 border-slate-800/50">
                <div id="placeholder" class="text-center p-8">
                    <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-700"><i data-lucide="image" class="w-8 h-8 text-slate-600"></i></div>
                    <p class="text-slate-500 font-medium text-sm">ç”»å¸ƒå‡†å¤‡å°±ç»ª</p>
                </div>
                <div id="loader" class="hidden flex flex-col items-center gap-4 z-20">
                    <div class="cyber-loader"></div>
                    <p class="text-indigo-400 font-bold text-xs tracking-widest animate-pulse">RENDERING...</p>
                </div>
                <img id="resultImg" class="hidden max-w-full max-h-[600px] object-contain shadow-2xl rounded-lg z-10 opacity-0 transition-opacity duration-500" onload="this.style.opacity=1" />
                <button id="dlBtn" onclick="downloadResult()" class="hidden absolute bottom-4 bg-white text-slate-900 px-5 py-2 rounded-full font-bold text-xs shadow-xl z-30 flex items-center gap-2 hover:scale-105 transition-transform">
                    <i data-lucide="download" class="w-3 h-3"></i> ä¿å­˜å›¾ç‰‡
                </button>
            </div>
        </main>
    </div>
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-3 rounded-full text-xs shadow-2xl hidden z-[200] border border-slate-700 flex items-center gap-2 whitespace-nowrap"></div>

    <script>
        // =================================================================
        // ğŸ‘‡ ğŸ”´ è¿™é‡Œï¼è¿™é‡Œï¼è¿™é‡Œï¼è¯·æŠŠä½ çš„ Key ç²˜è´´åˆ°ä¸‹é¢çš„å¼•å·é‡Œ ğŸ”´
        // =================================================================
        const SITE_CONFIG = {
            guest_key: "",  // ğŸ‘ˆ æŠŠä½ çš„ sk-xxxx ç²˜è´´åœ¨è¿™é‡Œï¼
            guest_provider: "openai"
        };
        // =================================================================

        let appState = { mode: 'txt2img', style: 'modern', imgBase64: null, provider: 'guest', userKey: '', isProcessing: false };
        const styles = [
            { id: 'modern', name: 'ğŸ® ç°ä»£æ¸¸æˆ', tags: 'masterpiece, best quality, game cg, ray tracing, 8k wallpaper' },
            { id: 'cell', name: 'ğŸ“º æ¸…æ–°èµ›ç’ç', tags: 'anime screencap, studio ghibli style, flat color' },
            { id: 'sketch', name: 'âœï¸ æè‡´çº¿ç¨¿', tags: 'monochrome, lineart, sketch, manga style' },
            { id: 'retro', name: 'ğŸ“¼ 90å¹´ä»£å¤å¤', tags: '1990s style, retro anime, vhs glitch' }
        ];

        function init() {
            lucide.createIcons();
            renderStyles();
            toggleAuthFields();
            switchMode('txt2img');
        }

        window.toggleAuthFields = () => {
            const provider = document.getElementById('providerSelect').value;
            const keyField = document.getElementById('keyField');
            const guestHint = document.getElementById('guestHint');
            const keyInput = document.getElementById('apiKeyInput');

            if (provider === 'guest') {
                keyField.classList.add('hidden');
                guestHint.classList.remove('hidden');
            } else {
                keyField.classList.remove('hidden');
                guestHint.classList.add('hidden');
                if(provider.includes('openai') || provider === 'chatgpt') keyInput.placeholder = "sk-... (OpenAI Key)";
                else if(provider === 'qwen') keyInput.placeholder = "sk-... (DashScope Key)";
                else keyInput.placeholder = "API Key...";
            }
        }

        window.saveAuthAndStart = () => {
            const provider = document.getElementById('providerSelect').value;
            const key = document.getElementById('apiKeyInput').value.trim();
            const errorBox = document.getElementById('loginError');
            const btn = document.getElementById('launchBtn');

            errorBox.classList.add('hidden');

            // æ¸¸å®¢æ¨¡å¼æ£€æŸ¥
            if (provider === 'guest') {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨ä»£ç é‡Œå¡«äº† Key
                if (!SITE_CONFIG.guest_key || SITE_CONFIG.guest_key.length < 5) {
                    errorBox.innerHTML = "âŒ <b>æœªæ£€æµ‹åˆ°å†…ç½® Keyï¼</b><br>è¯·å›åˆ°ä»£ç ç¼–è¾‘å™¨ï¼Œåœ¨ç¬¬ 138 è¡Œçš„ SITE_CONFIG é‡Œå¡«å…¥ Keyã€‚";
                    errorBox.classList.remove('hidden');
                    return;
                }
            } else {
                if (!key) {
                    errorBox.innerText = "âš ï¸ è¯·è¾“å…¥æ‚¨çš„ API Key";
                    errorBox.classList.remove('hidden');
                    return;
                }
            }

            btn.innerText = "æ­£åœ¨å¯åŠ¨...";

            setTimeout(() => {
                appState.provider = provider;
                appState.userKey = key;
                document.getElementById('authModal').classList.add('hidden-modal');
                const names = { 'guest': 'ğŸ æ¸¸å®¢æ¨¡å¼', 'openai': 'ğŸ¤– OpenAI', 'chatgpt': 'ğŸ’¬ ChatGPT' };
                document.getElementById('engineBadge').innerText = `Engine: ${names[provider] || provider}`;
                btn.innerText = "ç«‹å³å¯åŠ¨";
            }, 400);
        }

        window.openSettings = () => {
            document.getElementById('authModal').classList.remove('hidden-modal');
            document.getElementById('loginError').classList.add('hidden');
        }

        // --- æ ¸å¿ƒç”Ÿæˆé€»è¾‘ ---
        window.startGenerate = async () => {
            if (appState.isProcessing) return;
            const prompt = document.getElementById('promptInput').value.trim();
            const style = styles.find(s => s.id === appState.style);
            const fullPrompt = `${style.tags}, ${prompt}`;

            if (appState.mode !== 'txt2img' && !appState.imgBase64) return showToast("âš ï¸ è¯·å…ˆä¸Šä¼ å›¾ç‰‡");

            appState.isProcessing = true;
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('resultImg').classList.add('hidden');
            document.getElementById('genBtn').disabled = true;
            document.getElementById('genBtn').classList.add('opacity-50');

            try {
                let imgUrl = "";
                // å†³å®šä½¿ç”¨å“ªä¸ª Key
                const useKey = appState.provider === 'guest' ? SITE_CONFIG.guest_key : appState.userKey;
                // å†³å®š API åœ°å€ (è¿™é‡Œç»Ÿä¸€æ¼”ç¤º OpenAI æ ¼å¼)
                let baseUrl = "https://api.openai.com/v1";

                // å¦‚æœæ˜¯é€šä¹‰åƒé—®ç­‰ï¼Œå¯èƒ½éœ€è¦æ”¹ baseUrlï¼Œä½†æ ‡å‡† OpenAI æ ¼å¼å¦‚ä¸‹ï¼š
                const res = await fetch(`${baseUrl}/images/generations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${useKey}`
                    },
                    body: JSON.stringify({
                        model: "dall-e-3",
                        prompt: fullPrompt,
                        n: 1,
                        size: "1024x1024",
                        response_format: "b64_json"
                    })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                imgUrl = `data:image/png;base64,${data.data[0].b64_json}`;

                document.getElementById('resultImg').src = imgUrl;
                document.getElementById('resultImg').onload = () => {
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('resultImg').classList.remove('hidden');
                    document.getElementById('dlBtn').classList.remove('hidden');
                };

            } catch (e) {
                showToast("âŒ " + e.message);
                document.getElementById('placeholder').classList.remove('hidden');
                document.getElementById('loader').classList.add('hidden');
            } finally {
                appState.isProcessing = false;
                document.getElementById('genBtn').disabled = false;
                document.getElementById('genBtn').classList.remove('opacity-50');
            }
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function renderStyles() {
            document.getElementById('styleGrid').innerHTML = styles.map(s => `
                <div onclick="setStyle('${s.id}')" id="style-${s.id}" class="style-card border border-slate-700 bg-slate-800/50 p-3 rounded-xl cursor-pointer flex items-center justify-between ${appState.style === s.id ? 'active' : ''}">
                    <span class="text-xs font-bold text-slate-200">${s.name}</span>
                    ${appState.style === s.id ? '<i data-lucide="check-circle-2" class="w-3 h-3 text-indigo-400"></i>' : ''}
                </div>`).join('');
            lucide.createIcons();
        }
        window.setStyle = (id) => { appState.style = id; renderStyles(); };
        window.switchMode = (mode) => {
            appState.mode = mode;
            document.querySelectorAll('.mode-tab').forEach(el => el.classList.remove('active', 'bg-indigo-600', 'text-white'));
            document.getElementById(`tab-${mode}`).classList.add('active', 'bg-indigo-600', 'text-white');
            const uploadCard = document.getElementById('uploadCard');
            if (mode === 'txt2img') uploadCard.classList.add('hidden'); else uploadCard.classList.remove('hidden');
        }
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    appState.imgBase64 = evt.target.result.split(',')[1];
                    document.getElementById('previewImg').src = evt.target.result;
                    document.getElementById('uploadBox').classList.add('hidden');
                    document.getElementById('previewBox').classList.remove('hidden');
                    if (appState.mode === 'txt2img') switchMode('redraw');
                };
                reader.readAsDataURL(file);
            }
        });
        window.clearImage = (e) => {
            e.stopPropagation();
            appState.imgBase64 = null;
            document.getElementById('previewBox').classList.add('hidden');
            document.getElementById('uploadBox').classList.remove('hidden');
        };
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }
        window.downloadResult = () => {
            const link = document.createElement('a');
            link.href = document.getElementById('resultImg').src;
            link.download = `anime-${Date.now()}.png`;
            link.click();
        }
        init();
    </script>
</body>
</html>