<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ç»˜å›¾æœº | 111111666.xyz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .active-tab { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top-color: #818cf8; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        input, textarea, select { transition: all 0.2s; }
        input:focus, textarea:focus, select:focus { border-color: #818cf8; ring: 2px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-[url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop')] bg-cover bg-center">
    <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>

    <div class="relative w-full max-w-lg space-y-4">
        <!-- Header -->
        <header class="flex justify-between items-center px-2">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
                    <i data-lucide="palette" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl text-white tracking-tight">AI Drawing</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest">Version 3.0 Cloud</p>
                </div>
            </div>
            <div class="flex flex-col items-end gap-1">
                <select id="providerSelect" onchange="toggleKey()" class="bg-slate-800 border border-slate-700 text-xs rounded-lg px-2 py-1.5 outline-none focus:border-indigo-500">
                    <option value="guest" selected>ğŸ æ¸¸å®¢æ¨¡å¼ (å…è´¹/ç¨³å®š)</option>
                    <option value="google">âš¡ Google Gemini</option>
                    <option value="openai">ğŸ¤– OpenAI DALL-E 3</option>
                </select>
                <input id="userKey" type="password" class="hidden w-36 bg-slate-800/80 border border-slate-600 text-[10px] rounded px-2 py-1 outline-none text-right placeholder-slate-500 focus:w-48 transition-all" placeholder="ç²˜è´´ä½ çš„ API Key">
            </div>
        </header>

        <!-- Main Card -->
        <div class="glass rounded-3xl p-5 shadow-2xl space-y-5">
            <!-- Mode Switcher -->
            <div class="flex bg-slate-900/50 p-1.5 rounded-xl">
                <button onclick="setMode('txt2img')" id="btn-txt2img" class="flex-1 py-2.5 text-xs font-bold rounded-lg active-tab transition-all">æ–‡ç”Ÿå›¾</button>
                <button onclick="setMode('colorize')" id="btn-colorize" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all">çº¿ç¨¿ä¸Šè‰²</button>
                <button onclick="setMode('lineart')" id="btn-lineart" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all">æå–çº¿ç¨¿</button>
            </div>

            <!-- Upload Area (Hidden by default) -->
            <div id="uploadArea" class="hidden relative group">
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFile(this)">
                <div id="uploadPlaceholder" onclick="document.getElementById('fileInput').click()" class="border-2 border-dashed border-slate-600 rounded-2xl h-24 flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 hover:bg-slate-800/50 transition-all">
                    <i data-lucide="upload-cloud" class="mb-2 text-slate-400 group-hover:text-indigo-400"></i>
                    <span class="text-xs text-slate-400">ç‚¹å‡»ä¸Šä¼ å‚è€ƒå›¾</span>
                </div>
                <div id="previewBox" class="hidden relative rounded-2xl overflow-hidden border border-slate-600">
                    <img id="previewImg" class="w-full h-32 object-cover opacity-60">
                    <button onclick="clearFile()" class="absolute top-2 right-2 bg-red-500/80 hover:bg-red-600 text-white p-1.5 rounded-full transition-colors">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                    <div class="absolute bottom-2 left-2 text-[10px] bg-black/60 px-2 py-1 rounded text-white">å‚è€ƒå›¾å·²å°±ç»ª</div>
                </div>
            </div>

            <!-- Prompt Input -->
            <div class="relative">
                <textarea id="prompt" class="w-full h-28 bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-sm outline-none resize-none focus:border-indigo-500/50 placeholder-slate-500" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„ç”»é¢ (æ”¯æŒä¸­æ–‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¼˜åŒ–)..."></textarea>
                <div class="absolute bottom-3 right-3 text-[10px] text-slate-600">English Prompt works best</div>
            </div>

            <!-- Generate Button -->
            <button onclick="generate()" id="genBtn" class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 py-3.5 rounded-xl font-bold text-sm shadow-lg shadow-indigo-900/20 active:scale-[0.98] transition-all flex justify-center items-center gap-2 group">
                <i data-lucide="sparkles" class="w-4 h-4 group-hover:rotate-12 transition-transform"></i> 
                <span>å¼€å§‹ç”Ÿæˆ</span>
            </button>
        </div>

        <!-- Result Card -->
        <div id="resultBox" class="glass rounded-3xl min-h-[320px] flex items-center justify-center relative overflow-hidden hidden transition-all duration-500">
            <div id="loadingState" class="hidden flex flex-col items-center gap-3">
                <div class="loader"></div>
                <span class="text-xs text-indigo-300 animate-pulse font-mono">AI æ­£åœ¨ç»˜åˆ¶ä¸­...</span>
            </div>
            
            <img id="resultImg" class="w-full h-auto object-contain hidden shadow-2xl">
            
            <div id="actionButtons" class="hidden absolute bottom-4 flex gap-3 z-20">
                <button onclick="downloadImg()" class="bg-white/10 hover:bg-white/20 backdrop-blur text-white px-4 py-2 rounded-full text-xs font-bold border border-white/10 flex items-center gap-2 transition-all">
                    <i data-lucide="download" class="w-3 h-3"></i> ä¿å­˜
                </button>
                <button onclick="document.getElementById('resultBox').classList.add('hidden')" class="bg-black/40 hover:bg-black/60 backdrop-blur text-white px-4 py-2 rounded-full text-xs font-bold border border-white/10 transition-all">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>

    <script>
        let state = { mode: 'txt2img', image: null };
        function init() { lucide.createIcons(); }
        function toggleKey() { 
            const isGuest = document.getElementById('providerSelect').value === 'guest';
            document.getElementById('userKey').classList.toggle('hidden', isGuest);
        }
        
        function setMode(m) {
            state.mode = m;
            document.querySelectorAll('button[id^="btn-"]').forEach(b => { 
                b.className = "flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all";
            });
            const activeBtn = document.getElementById('btn-' + m);
            activeBtn.className = "flex-1 py-2.5 text-xs font-bold rounded-lg active-tab transition-all";
            
            const uploadArea = document.getElementById('uploadArea');
            if (m === 'txt2img') {
                uploadArea.classList.add('hidden');
                state.image = null;
            } else {
                uploadArea.classList.remove('hidden');
            }
        }

        function handleFile(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { 
                state.image = e.target.result.split(',')[1]; 
                document.getElementById('previewImg').src = e.target.result; 
                document.getElementById('uploadPlaceholder').classList.add('hidden'); 
                document.getElementById('previewBox').classList.remove('hidden'); 
            };
            reader.readAsDataURL(file);
        }

        function clearFile() { 
            state.image = null; 
            document.getElementById('uploadPlaceholder').classList.remove('hidden'); 
            document.getElementById('previewBox').classList.add('hidden'); 
            document.getElementById('fileInput').value = ''; 
        }

        async function generate() {
            const prompt = document.getElementById('prompt').value.trim();
            const provider = document.getElementById('providerSelect').value;
            const userKey = document.getElementById('userKey').value.trim();

            if (!prompt && state.mode === 'txt2img') return alert("è¯·æè¿°ä½ æƒ³è¦çš„ç”»é¢");
            if (state.mode !== 'txt2img' && !state.image) return alert("è¯·ä¸Šä¼ å‚è€ƒåº•å›¾");

            const btn = document.getElementById('genBtn');
            const resultBox = document.getElementById('resultBox');
            const loader = document.getElementById('loadingState');
            const img = document.getElementById('resultImg');
            const actions = document.getElementById('actionButtons');

            // UI State: Loading
            btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed');
            resultBox.classList.remove('hidden');
            loader.classList.remove('hidden');
            img.classList.add('hidden');
            actions.classList.add('hidden');
            resultBox.scrollIntoView({ behavior: 'smooth', block: 'center' });

            try {
                const res = await fetch('/api/generate', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        provider, 
                        mode: state.mode, 
                        prompt, 
                        image: state.image, 
                        api_key: userKey 
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || "ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Key");

                const imageUrl = data.image_url ? data.image_url : "data:image/png;base64," + data.image_b64;
                
                // Preload image
                const tempImg = new Image();
                tempImg.src = imageUrl;
                tempImg.onload = () => {
                    img.src = imageUrl;
                    loader.classList.add('hidden');
                    img.classList.remove('hidden');
                    actions.classList.remove('hidden');
                };
            } catch (e) { 
                alert("é”™è¯¯: " + e.message); 
                resultBox.classList.add('hidden');
            } finally { 
                btn.disabled = false; 
                btn.classList.remove('opacity-50', 'cursor-not-allowed'); 
            }
        }

        function downloadImg() { 
            const a = document.createElement('a'); 
            a.href = document.getElementById('resultImg').src; 
            a.download = `AI-Art-${Date.now()}.png`; 
            document.body.appendChild(a);
            a.click(); 
            document.body.removeChild(a);
        }
        
        init();
    </script>
</body>
</html>

