<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒæ¬¡å…ƒç»˜å›¾æœº 1.1.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
        .mode-tab.active { background-color: #4f46e5; color: white; border-color: #6366f1; }
        .style-card.active { background: linear-gradient(135deg, rgba(79, 70, 229, 0.2), rgba(124, 58, 237, 0.1)); border-color: #818cf8; }
        .cyber-loader { width: 40px; height: 40px; border: 3px solid #334155; border-top-color: #818cf8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #authModal { transition: opacity 0.3s, transform 0.3s; }
        #authModal.hidden-modal { opacity: 0; pointer-events: none; transform: scale(1.1); }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-appearance: none; appearance: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-3 md:p-6 pb-24">

    <!-- 1. å¯åŠ¨é…ç½®é®ç½© -->
    <div id="authModal" class="fixed inset-0 z-[100] bg-[#0f172a] flex flex-col items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm p-8 rounded-3xl border border-indigo-500/30 shadow-2xl relative">
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-600/20">
                    <i data-lucide="power" class="text-white w-7 h-7"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">é…ç½®å¼•æ“</h2>
                <p class="text-slate-400 text-xs mt-1">ç‰ˆæœ¬ v1.1.4 (æœ€ç»ˆä¿®æ­£ç‰ˆ)</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-indigo-300 ml-1">æ¨¡å‹æä¾›å•† (Provider)</label>
                    <select id="providerSelect" onchange="toggleAuthFields()" class="w-full bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl outline-none mt-1 focus:border-indigo-500 transition-colors">
                        <option value="guest" selected>ğŸ æœ¬åœ°æ¸¸å®¢æ¨¡å¼ (å†…ç½®Key)</option>
                        <option value="google">â˜ï¸ Google Gemini (å…è´¹æ¨è)</option>
                        <option value="openai">ğŸ¤– OpenAI (DALL-E)</option>
                    </select>
                </div>
                
                <div id="keyField" class="hidden">
                    <label class="text-xs font-bold text-indigo-300 ml-1">API Key (å¯†é’¥)</label>
                    <input type="password" id="apiKeyInput" class="w-full bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl outline-none mt-1 font-mono text-center tracking-wider focus:border-indigo-500 transition-colors" placeholder="ç²˜è´´å¯†é’¥..." />
                </div>

                <div id="guestHint" class="text-[11px] text-slate-400 bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 leading-relaxed">
                    <span class="text-indigo-400 font-bold">â„¹ï¸ æç¤ºï¼š</span> è¯·ç¡®ä¿æ‚¨å·²åœ¨ä»£ç ç¬¬ 138 è¡Œå¡«å…¥ `AIzaSy` å¼€å¤´çš„ Keyã€‚
                </div>
                
                <div id="loginError" class="hidden text-xs text-red-400 text-center bg-red-500/10 p-2 rounded-lg border border-red-500/20"></div>
            </div>

            <button onclick="saveAuthAndStart()" id="launchBtn" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-500/25 active:scale-95 transition-all">
                ç«‹å³å¯åŠ¨
            </button>
        </div>
    </div>

    <!-- 2. é¡¶éƒ¨æ  -->
    <header class="max-w-4xl mx-auto w-full flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                <i data-lucide="zap" class="text-white w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-white tracking-tight leading-none">äºŒæ¬¡å…ƒç»˜å›¾æœº <span class="text-indigo-400">1.1.4</span></h1>
                <p class="text-[10px] text-slate-400 font-mono mt-0.5" id="engineBadge">Engine: Waiting</p>
            </div>
        </div>
        <button onclick="openSettings()" class="p-2 bg-slate-800/50 rounded-lg text-slate-400 hover:text-white border border-slate-700 transition-colors">
            <i data-lucide="settings-2" class="w-5 h-5"></i>
        </button>
    </header>

    <!-- åŠŸèƒ½åˆ‡æ¢ -->
    <div class="max-w-4xl mx-auto w-full mb-4 overflow-x-auto no-scrollbar">
        <div class="flex gap-2 min-w-max">
            <button onclick="switchMode('txt2img')" id="tab-txt2img" class="mode-tab active px-4 py-2 rounded-xl bg-slate-800 text-slate-400 text-xs font-bold border border-transparent transition-all">çµæ„Ÿç»˜å›¾</button>
            <button onclick="switchMode('colorize')" id="tab-colorize" class="mode-tab px-4 py-2 rounded-xl bg-slate-800 text-slate-400 text-xs font-bold border border-transparent transition-all">è‡ªåŠ¨ä¸Šè‰²</button>
            <button onclick="switchMode('lineart')" id="tab-lineart" class="mode-tab px-4 py-2 rounded-xl bg-slate-800 text-slate-400 text-xs font-bold border border-transparent transition-all">çº¿ç¨¿æå–</button>
            <button onclick="switchMode('redraw')" id="tab-redraw" class="mode-tab px-4 py-2 rounded-xl bg-slate-800 text-slate-400 text-xs font-bold border border-transparent transition-all">é£æ ¼é‡ç»˜</button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto w-full flex flex-col lg:flex-row gap-4">
        <aside class="w-full lg:w-1/3 flex flex-col gap-4">
            <div class="glass-panel p-4 rounded-2xl">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 block">ç”»é£é¢„è®¾</label>
                <div class="grid grid-cols-2 gap-2" id="styleGrid"></div>
            </div>
            <div id="uploadCard" class="glass-panel p-4 rounded-2xl hidden">
                <label class="text-xs font-bold text-slate-500 mb-3 block">å‚è€ƒåº•å›¾ (å¿…é€‰)</label>
                <input type="file" id="imageInput" class="hidden" accept="image/*" />
                <div id="uploadBox" class="h-32 border-2 border-dashed border-slate-700 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-800/50 transition-all" onclick="document.getElementById('imageInput').click()">
                    <i data-lucide="image-plus" class="text-slate-400 mb-2"></i>
                    <span class="text-[10px] text-slate-500">ç‚¹å‡»ä¸Šä¼ å‚è€ƒå›¾ç‰‡</span>
                </div>
                <div id="previewBox" class="hidden relative h-40 bg-slate-900 rounded-xl overflow-hidden border border-slate-700">
                    <img id="previewImg" class="w-full h-full object-contain" />
                    <button onclick="clearImage()" class="absolute top-2 right-2 bg-black/60 text-white p-1 rounded-lg"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            </div>
        </aside>

        <main class="w-full lg:w-2/3 flex flex-col gap-4">
            <textarea id="promptInput" class="glass-panel w-full h-24 bg-transparent text-sm p-4 rounded-2xl resize-none outline-none placeholder-slate-600 text-slate-200" placeholder="åœ¨æ­¤è¾“å…¥ç”»é¢æè¿°..."></textarea>
            <button onclick="startGenerate()" id="genBtn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all">å¼€å§‹ç”Ÿæˆ</button>
            <div id="outputArea" class="glass-panel rounded-2xl min-h-[350px] flex items-center justify-center relative overflow-hidden bg-slate-900/30">
                <div id="loader" class="hidden flex flex-col items-center gap-4 z-20">
                    <div class="cyber-loader"></div>
                    <p class="text-indigo-400 font-bold text-xs animate-pulse">æ­£åœ¨åˆ©ç”¨ AI ç®—åŠ›ç»˜å›¾ä¸­...</p>
                </div>
                <img id="resultImg" class="hidden max-w-full max-h-[600px] object-contain shadow-2xl rounded-lg z-10" />
                <div id="placeholder" class="text-center p-8 text-slate-600 flex flex-col items-center gap-2">
                    <i data-lucide="image" class="w-8 h-8"></i>
                    <span class="text-sm">ç”»å¸ƒå‡†å¤‡å°±ç»ª</span>
                </div>
                <button id="dlBtn" onclick="downloadResult()" class="hidden absolute bottom-4 bg-white text-slate-900 px-5 py-2 rounded-full font-bold text-xs shadow-xl z-30 flex items-center gap-2">
                    <i data-lucide="download" class="w-3 h-3"></i> ä¸‹è½½å›¾ç‰‡
                </button>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-3 rounded-full text-xs hidden z-[200] border border-slate-700"></div>

    <script>
        // =================================================================
        // ğŸ‘‡ ğŸ”´ è¿™é‡Œï¼å¡«å…¥ä½ çš„ Google Key (AIzaSyå¼€å¤´) ç”¨äºæ¸¸å®¢æ¨¡å¼
        // =================================================================
        const SITE_CONFIG = {
            guest_key: "", // ç²˜è´´åœ¨è¿™é‡Œ
            guest_provider: "google" 
        };
        // =================================================================

        let appState = { mode: 'txt2img', style: 'modern', imgBase64: null, provider: 'guest', userKey: '', isProcessing: false };
        const styles = [
            { id: 'modern', name: 'ğŸ® ç°ä»£æ¸¸æˆ', tags: 'masterpiece, best quality, game cg, ray tracing, 8k wallpaper' },
            { id: 'cell', name: 'ğŸ“º æ¸…æ–°èµ›ç’ç', tags: 'anime style, flat color, studio ghibli, clean lines' },
            { id: 'sketch', name: 'âœï¸ æè‡´çº¿ç¨¿', tags: 'monochrome, lineart, sketch, manga style, white background' },
            { id: 'retro', name: 'ğŸ“¼ 90å¹´ä»£å¤å¤', tags: '1990s style, retro anime, old anime' }
        ];

        function init() {
            lucide.createIcons();
            renderStyles();
            toggleAuthFields();
            switchMode('txt2img');
        }

        window.toggleAuthFields = () => {
            const val = document.getElementById('providerSelect').value;
            document.getElementById('keyField').classList.toggle('hidden', val === 'guest');
            document.getElementById('guestHint').classList.toggle('hidden', val !== 'guest');
        }

        window.saveAuthAndStart = () => {
            const provider = document.getElementById('providerSelect').value;
            const key = document.getElementById('apiKeyInput').value.trim();
            if (provider === 'guest' && !SITE_CONFIG.guest_key) return showToast("âŒ è¯·å…ˆåœ¨ä»£ç ç¬¬ 138 è¡Œå¡«å…¥ Key");
            
            appState.provider = provider;
            appState.userKey = key;
            document.getElementById('authModal').classList.add('hidden-modal');
            const names = { 'guest': 'æˆ¿ä¸»èµåŠ©', 'google': 'Google', 'openai': 'OpenAI' };
            document.getElementById('engineBadge').innerText = `Engine: ${names[provider]}`;
        }

        window.openSettings = () => document.getElementById('authModal').classList.remove('hidden-modal');

        window.startGenerate = async () => {
            if (appState.isProcessing) return;
            const prompt = document.getElementById('promptInput').value.trim();
            const style = styles.find(s => s.id === appState.style);
            const useKey = appState.provider === 'guest' ? SITE_CONFIG.guest_key : appState.userKey;
            const provider = appState.provider === 'guest' ? SITE_CONFIG.guest_provider : appState.provider;

            if (appState.mode !== 'txt2img' && !appState.imgBase64) return showToast("âš ï¸ è¯·å…ˆä¸Šä¼ å‚è€ƒå›¾");

            appState.isProcessing = true;
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('resultImg').classList.add('hidden');
            document.getElementById('dlBtn').classList.add('hidden');

            try {
                let imgUrl = "";
                if (provider === 'google') {
                    // --- æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ç¨³å®šçš„ Google æ¨¡å‹åå­— ---
                    const modelName = "gemini-1.5-flash"; 
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${useKey}`;
                    
                    let taskText = "";
                    if (appState.mode === 'txt2img') taskText = `Draw a high-quality anime artwork: ${style.tags}, ${prompt}. Output as base64 image.`;
                    else if (appState.mode === 'lineart') taskText = "Extract clean black and white lineart from this image.";
                    else if (appState.mode === 'colorize') taskText = `Colorize this lineart in vibrant anime style. Wishes: ${prompt}`;
                    else taskText = `Redraw this in ${style.name} style. ${prompt}`;

                    const payload = { 
                        contents: [{ 
                            parts: [
                                { text: taskText },
                                ...(appState.imgBase64 ? [{ inlineData: { mimeType: "image/png", data: appState.imgBase64 } }] : [])
                            ] 
                        }],
                        // å°è¯•è¯·æ±‚å›¾åƒè¾“å‡º (æ³¨æ„ï¼šImagen æƒé™å—é™å¯èƒ½å¯¼è‡´æ­¤æ­¥å¤±è´¥ï¼Œå¦‚æœå¤±è´¥ä¼šè¿›å…¥ catch)
                        generationConfig: { responseModalities: ["IMAGE"] } 
                    };
                    
                    const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                    const data = await res.json();
                    
                    if (data.error) throw new Error(`Google API: ${data.error.message}`);
                    
                    const imagePart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                    if (!imagePart) throw new Error("æ­¤ Key æš‚æœªå¼€é€š Google ç»˜å›¾æƒé™ï¼Œè¯·å°è¯•åœ¨â€˜è®¾ç½®â€™é‡Œåˆ‡æ¢ä¸º OpenAI å¼•æ“ã€‚");
                    imgUrl = `data:image/png;base64,${imagePart.inlineData.data}`;

                } else {
                    // OpenAI é€»è¾‘
                    if (appState.mode !== 'txt2img') throw new Error("OpenAI å¼•æ“ç›®å‰ä»…æ”¯æŒâ€˜çµæ„Ÿç»˜å›¾â€™ã€‚");
                    const res = await fetch('https://api.openai.com/v1/images/generations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${useKey}` },
                        body: JSON.stringify({ model: "dall-e-3", prompt: `${style.tags}, ${prompt}`, response_format: "b64_json" })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error.message);
                    imgUrl = `data:image/png;base64,${data.data[0].b64_json}`;
                }

                document.getElementById('resultImg').src = imgUrl;
                document.getElementById('resultImg').classList.remove('hidden');
                document.getElementById('dlBtn').classList.remove('hidden');
            } catch (e) {
                showToast("âŒ " + e.message);
                document.getElementById('placeholder').classList.remove('hidden');
            } finally {
                document.getElementById('loader').classList.add('hidden');
                appState.isProcessing = false;
            }
        }

        function renderStyles() {
            document.getElementById('styleGrid').innerHTML = styles.map(s => `
                <div onclick="setStyle('${s.id}')" class="style-card border border-slate-700 bg-slate-800/50 p-2 rounded-xl text-center text-[10px] font-bold cursor-pointer transition-all ${appState.style === s.id ? 'active' : ''}">
                    ${s.name}
                </div>`).join('');
        }
        window.setStyle = (id) => { appState.style = id; renderStyles(); };
        window.switchMode = (mode) => {
            appState.mode = mode;
            document.querySelectorAll('.mode-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            document.getElementById('uploadCard').classList.toggle('hidden', mode === 'txt2img');
            const hints = {
                txt2img: "æè¿°ä½ æƒ³çœ‹åˆ°çš„ç”»é¢...",
                colorize: "æè¿°é…è‰²è¦æ±‚ (å¦‚: ç²‰è‰²è°ƒ)...",
                lineart: "ä¸éœ€è¦è¾“å…¥ï¼Œç›´æ¥ç‚¹å¼€å§‹ç”Ÿæˆ...",
                redraw: "æè¿°éœ€è¦ä¿®æ”¹çš„ç»†èŠ‚..."
            };
            document.getElementById('promptInput').placeholder = hints[mode];
        }
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                appState.imgBase64 = evt.target.result.split(',')[1];
                document.getElementById('previewImg').src = evt.target.result;
                document.getElementById('uploadBox').classList.add('hidden');
                document.getElementById('previewBox').classList.remove('hidden');
            };
            reader.readAsDataURL(e.target.files[0]);
        });
        window.clearImage = () => {
            appState.imgBase64 = null;
            document.getElementById('previewBox').classList.add('hidden');
            document.getElementById('uploadBox').classList.remove('hidden');
            document.getElementById('imageInput').value = '';
        };
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 5000);
        }
        window.downloadResult = () => {
            const link = document.createElement('a');
            link.href = document.getElementById('resultImg').src;
            link.download = `anime-${Date.now()}.png`;
            link.click();
        }
        init();
    </script>
</body>
</html>
