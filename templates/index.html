<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç»˜å›¾å·¥åŠ Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* å­—ä½“ä¸é…è‰²åŸºç¡€ */
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background-color: #020617; color: #e2e8f0; }
        
        /* ç»ç’ƒæ‹Ÿæ€ä¾§è¾¹æ  */
        .sidebar { background: rgba(15, 23, 42, 0.95); border-right: 1px solid rgba(255,255,255,0.05); }
        
        /* æ§ä»¶æ ·å¼ */
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; transition: all 0.2s; }
        .input-dark:focus { border-color: #6366f1; outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        
        /* é€‰ä¸­çŠ¶æ€ */
        .tab-btn { transition: all 0.2s; opacity: 0.6; }
        .tab-btn.active { opacity: 1; background: #334155; border-left: 3px solid #6366f1; }
        
        /* æ»šåŠ¨æ¡éšè— */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æŒ‰é’®æ¸å˜ */
        .btn-primary { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-primary:active { transform: scale(0.98); }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- ğŸ”¥ å·¦ä¾§ä¾§è¾¹æ  (åŠŸèƒ½æ§åˆ¶åŒº) -->
    <aside class="sidebar w-80 flex-shrink-0 flex flex-col h-full overflow-y-auto no-scrollbar z-20 shadow-2xl">
        <!-- Logo -->
        <div class="p-6 border-b border-white/5 flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/30">
                <i data-lucide="pen-tool" class="text-white w-5 h-5"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight">AI Drawing</h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest">Zeabur Edition</p>
            </div>
        </div>

        <!-- æ ¸å¿ƒæ§åˆ¶ -->
        <div class="p-4 space-y-6 flex-1">
            
            <!-- å¼•æ“é€‰æ‹© -->
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">ç»˜å›¾å¼•æ“</label>
                <div class="flex gap-2 mb-2">
                    <select id="provider" onchange="toggleKey()" class="w-full input-dark rounded-lg px-3 py-2 text-xs">
                        <option value="guest">ğŸ æ¸¸å®¢æ¨¡å¼ (å…è´¹/æ— é™)</option>
                        <option value="openai">ğŸ¤– OpenAI (éœ€Key/ä½™é¢)</option>
                    </select>
                </div>
                <input id="apiKey" type="password" class="hidden w-full input-dark rounded-lg px-3 py-2 text-xs" placeholder="è¾“å…¥ sk-xxxxxx Key...">
            </div>

            <!-- ğŸ¨ åˆ›ä½œæ¨¡å¼ -->
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">åˆ›ä½œæ¨¡å¼</label>
                <div class="grid grid-cols-3 gap-1 bg-slate-800 p-1 rounded-lg">
                    <button onclick="setMode('txt2img')" id="mode-txt2img" class="text-xs py-2 rounded-md bg-indigo-600 text-white shadow font-medium transition-all">æ–‡ç”Ÿå›¾</button>
                    <button onclick="setMode('lineart')" id="mode-lineart" class="text-xs py-2 rounded-md text-slate-400 hover:text-white transition-all">æå–çº¿ç¨¿</button>
                    <button onclick="setMode('colorize')" id="mode-colorize" class="text-xs py-2 rounded-md text-slate-400 hover:text-white transition-all">çº¿ç¨¿ä¸Šè‰²</button>
                </div>
            </div>

            <!-- ğŸ­ é£æ ¼é€‰æ‹©å™¨ -->
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">ç”»é£é¢„è®¾</label>
                <select id="styleSelect" class="w-full input-dark rounded-lg px-3 py-2.5 text-sm cursor-pointer">
                    <option value="default">âœ¨ é»˜è®¤ (äºŒæ¬¡å…ƒé€šç”¨)</option>
                    <optgroup label="ç»˜ç”»æŠ€æ³•">
                        <option value="impasto">ğŸ¨ åšæ¶‚ / æ²¹ç”»è´¨æ„Ÿ</option>
                        <option value="cel_shading">ğŸ“º èµ›ç’ç’ / TVåŠ¨ç”»</option>
                        <option value="watercolor">ğŸ’§ æ°´å½© / æ²»æ„ˆç³»</option>
                        <option value="sketch">âœï¸ ç´ æ / æ‰‹ç»˜çº¿ç¨¿</option>
                        <option value="ink">âœ’ï¸ æ°´å¢¨ / ä¸œæ–¹éŸµå‘³</option>
                        <option value="pixel">ğŸ‘¾ åƒç´ ç”» / å¤å¤æ¸¸æˆ</option>
                    </optgroup>
                    <optgroup label="çŸ¥åç”»å¸ˆé£æ ¼">
                        <option value="wlop">ğŸ‘‘ WLOP (å”¯ç¾å…‰å½±)</option>
                        <option value="guweiz">âš”ï¸ Guweiz (å†·é…·å™äº‹)</option>
                        <option value="ask">ğŸŒ¸ Ask (æ¸©æŸ”å¹³æ¶‚)</option>
                        <option value="mika_pikazo">ğŸŒˆ Mika Pikazo (é²œè‰³æ³¢æ™®)</option>
                        <option value="ilya">ğŸ’„ Ilya Kuvshinov (æ—¶å°š)</option>
                        <option value="redjuice">ğŸ¤– Redjuice (ç§‘æŠ€é‡‘å±)</option>
                        <option value="mucha">âšœï¸ æ…•å¤ (åä¸½è£…é¥°)</option>
                        <option value="clamp">ğŸ¦‹ Clamp (åä¸½å°‘å¥³æ¼«)</option>
                    </optgroup>
                    <optgroup label="æ°›å›´ç¾å­¦">
                        <option value="cyberpunk">ğŸŒƒ èµ›åšæœ‹å…‹</option>
                        <option value="steampunk">âš™ï¸ è’¸æ±½æœ‹å…‹</option>
                        <option value="gothic">ğŸ° å“¥ç‰¹ / æš—é»‘</option>
                        <option value="vaporwave">ğŸ“¼ è’¸æ±½æ³¢ / 80så¤å¤</option>
                        <option value="dreamy">ğŸ¦„ æ¢¦å¹» / ç«¥è¯</option>
                    </optgroup>
                </select>
            </div>

            <!-- âœ¨ å…‰å½±ç‰¹æ•ˆ -->
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">å…‰å½±ä¸é•œå¤´</label>
                <select id="lightingSelect" class="w-full input-dark rounded-lg px-3 py-2.5 text-sm cursor-pointer">
                    <option value="none">æ— ç‰¹æ•ˆ</option>
                    <optgroup label="å…‰å½±å¢å¼º">
                        <option value="cinematic">ğŸ¬ ç”µå½±çº§å…‰æ•ˆ</option>
                        <option value="volumetric">â›… ä¸è¾¾å°”ä½“ç§¯å…‰</option>
                        <option value="bioluminescence">âœ¨ ç”Ÿç‰©è§å…‰/å‘å…‰</option>
                        <option value="raytracing">ğŸ”® å…‰çº¿è¿½è¸ª/çœŸå®æ„Ÿ</option>
                        <option value="rim_light">ğŸ‘¤ è½®å»“å…‰/èƒŒå…‰</option>
                    </optgroup>
                    <optgroup label="é•œå¤´è§†è§’">
                        <option value="fisheye">ğŸŸ é±¼çœ¼/å¤§é€è§†</option>
                        <option value="dutch">ğŸ“ è·å…°å¼å€¾æ–œ</option>
                        <option value="close_up">ğŸ‘€ è„¸éƒ¨ç‰¹å†™</option>
                        <option value="full_body">ğŸ§ å…¨èº«ç«‹ç»˜</option>
                    </optgroup>
                </select>
            </div>

            <!-- ğŸ“ æç¤ºè¯ -->
            <div class="flex-1 flex flex-col">
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">ç”»é¢æè¿°</label>
                <textarea id="prompt" class="w-full flex-1 input-dark rounded-lg p-3 text-sm resize-none leading-relaxed placeholder-slate-600 focus:bg-slate-800" placeholder="åœ¨æ­¤æè¿°ç”»é¢å†…å®¹...
ä¾‹å¦‚ï¼šé“¶å‘å°‘å¥³ï¼Œçº¢çœ¼ç›ï¼Œç«™åœ¨é›¨ä¸­çš„éœ“è™¹è¡—é“..."></textarea>
            </div>
        </div>

        <!-- åº•éƒ¨ç”ŸæˆæŒ‰é’® -->
        <div class="p-4 border-t border-white/5 bg-slate-900/50">
            <button onclick="generate()" id="genBtn" class="w-full btn-primary text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-500/20 flex justify-center items-center gap-2 transition-all">
                <i data-lucide="sparkles" class="w-5 h-5"></i>
                <span id="btnText">å¼€å§‹ç”Ÿæˆ</span>
            </button>
        </div>
    </aside>

    <!-- ğŸ–¼ï¸ å³ä¾§ä¸»ç”»å¸ƒ (å±•ç¤ºä¸æ“ä½œ) -->
    <main class="flex-1 relative bg-[url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=1974&auto=format&fit=crop')] bg-cover bg-center flex flex-col items-center justify-center p-4 sm:p-8">
        <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm"></div>

        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div id="seedBar" class="hidden absolute top-6 bg-black/40 backdrop-blur border border-indigo-500/30 text-white px-4 py-2 rounded-full flex items-center gap-3 animate-in fade-in slide-in-from-top-4 z-10">
            <div class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div>
            <span class="text-xs font-mono text-indigo-200">SEED LOCKED: <span id="currentSeed"></span></span>
            <button onclick="unlockSeed()" class="hover:text-white text-white/50 transition-colors" title="è§£é”ç§å­"><i data-lucide="unlock" class="w-3 h-3"></i></button>
        </div>

        <!-- ç”»å¸ƒå®¹å™¨ -->
        <div class="relative w-full max-w-[800px] aspect-square max-h-[85vh] bg-slate-900/50 rounded-2xl border border-white/10 shadow-2xl flex items-center justify-center overflow-hidden group">
            
            <!-- ç©ºçŠ¶æ€ -->
            <div id="emptyState" class="text-center">
                <div class="w-24 h-24 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-4 border border-white/5">
                    <i data-lucide="image-plus" class="w-10 h-10 text-slate-600"></i>
                </div>
                <h3 class="text-slate-400 font-medium">å‡†å¤‡å°±ç»ª</h3>
                <p class="text-slate-600 text-xs mt-2">åœ¨å·¦ä¾§é…ç½®å‚æ•°ï¼Œç‚¹å‡»ç”Ÿæˆ</p>
            </div>

            <!-- åŠ è½½åŠ¨ç”» -->
            <div id="loader" class="hidden absolute inset-0 bg-slate-900/80 z-20 flex flex-col items-center justify-center backdrop-blur-sm">
                <div class="relative w-20 h-20">
                    <div class="absolute inset-0 border-4 border-indigo-500/20 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-t-indigo-500 border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin"></div>
                </div>
                <p id="loadingText" class="mt-4 text-indigo-300 font-mono text-sm animate-pulse">AI æ­£åœ¨ç»˜å›¾...</p>
            </div>

            <!-- ç»“æœå›¾ç‰‡ -->
            <img id="resultImg" class="hidden w-full h-full object-contain shadow-2xl transition-all duration-500">

            <!-- å›¾ç‰‡æ‚¬æµ®æ“ä½œæ  -->
            <div id="imgActions" class="hidden absolute bottom-6 flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform translate-y-2 group-hover:translate-y-0">
                <button onclick="downloadImg()" class="bg-white text-slate-900 px-5 py-2.5 rounded-full text-sm font-bold shadow-xl hover:bg-slate-200 transition-colors flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> ä¸‹è½½
                </button>
                <button onclick="lockSeed()" id="refineBtn" class="bg-black/60 backdrop-blur text-white border border-white/20 px-5 py-2.5 rounded-full text-sm font-bold shadow-xl hover:bg-black/80 transition-colors flex items-center gap-2">
                    <i data-lucide="lock" class="w-4 h-4"></i> é”å®šæ„å›¾ (äºŒæ¬¡ä¿®æ”¹)
                </button>
            </div>
        </div>

    </main>

    <script>
        let state = { mode: 'txt2img', seed: null, lockedSeed: null };

        function init() { lucide.createIcons(); }
        
        function toggleKey() { 
            const isGuest = document.getElementById('provider').value === 'guest';
            document.getElementById('apiKey').classList.toggle('hidden', isGuest);
        }

        function setMode(mode) {
            state.mode = mode;
            // æŒ‰é’®æ ·å¼åˆ‡æ¢
            ['txt2img', 'lineart', 'colorize'].forEach(m => {
                const btn = document.getElementById('mode-' + m);
                if (m === mode) {
                    btn.className = "text-xs py-2 rounded-md bg-indigo-600 text-white shadow font-medium transition-all";
                } else {
                    btn.className = "text-xs py-2 rounded-md text-slate-400 hover:text-white transition-all";
                }
            });
            // æç¤ºè¯å ä½ç¬¦å˜åŒ–
            const p = document.getElementById('prompt');
            if (mode === 'lineart') p.placeholder = "æè¿°ä½ æƒ³ç”Ÿæˆçš„çº¿ç¨¿å†…å®¹...\nä¾‹å¦‚ï¼šå¤æ‚çš„æœºæ¢°åŸå ¡ï¼Œé»‘ç™½çº¿ç¨¿...";
            else if (mode === 'colorize') p.placeholder = "æè¿°ä½ æƒ³ç”Ÿæˆçš„ä¸Šè‰²é£æ ¼...\nä¾‹å¦‚ï¼šè‰²å½©æ–‘æ–“çš„æ¢¦å¢ƒï¼Œåšæ¶‚é£æ ¼...";
            else p.placeholder = "åœ¨æ­¤æè¿°ç”»é¢å†…å®¹...\nä¾‹å¦‚ï¼šé“¶å‘å°‘å¥³ï¼Œçº¢çœ¼ç›ï¼Œç«™åœ¨é›¨ä¸­çš„éœ“è™¹è¡—é“...";
        }

        function lockSeed() {
            if (!state.seed) return;
            state.lockedSeed = state.seed;
            document.getElementById('currentSeed').innerText = state.lockedSeed;
            document.getElementById('seedBar').classList.remove('hidden');
            document.getElementById('refineBtn').classList.add('hidden'); // é¿å…é‡å¤é”
            alert("æ„å›¾ç§å­å·²é”å®šï¼\nç°åœ¨ä¿®æ”¹å·¦ä¾§çš„æç¤ºè¯ã€é£æ ¼æˆ–å…‰å½±ï¼Œå†æ¬¡ç”Ÿæˆï¼Œç”»é¢ä¸»ä½“ç»“æ„å°†ä¿æŒä¸å˜ã€‚");
        }

        function unlockSeed() {
            state.lockedSeed = null;
            document.getElementById('seedBar').classList.add('hidden');
            if (state.seed) document.getElementById('refineBtn').classList.remove('hidden');
        }

        async function generate() {
            const prompt = document.getElementById('prompt').value.trim();
            const provider = document.getElementById('provider').value;
            const style = document.getElementById('styleSelect').value;
            const lighting = document.getElementById('lightingSelect').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!prompt) return alert("è¯·å…ˆè¾“å…¥ç”»é¢æè¿°");
            if (provider === 'openai' && !apiKey) return alert("OpenAI æ¨¡å¼å¿…é¡»å¡«å†™ Key");

            // UI Loading
            const btn = document.getElementById('genBtn');
            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('loader');
            const img = document.getElementById('resultImg');
            const actions = document.getElementById('imgActions');
            const empty = document.getElementById('emptyState');

            btn.disabled = true; btn.classList.add('opacity-50'); btnText.innerText = "ç”Ÿæˆä¸­...";
            loader.classList.remove('hidden');
            img.classList.add('hidden'); actions.classList.add('hidden'); empty.classList.add('hidden');

            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider,
                        mode: state.mode,
                        prompt,
                        style,
                        lighting,
                        api_key: apiKey,
                        seed: state.lockedSeed // å…³é”®ï¼šä¼ è¾“é”å®šç§å­
                    })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error);

                const src = data.image_url ? data.image_url : "data:image/png;base64," + data.image_b64;
                
                // æ›´æ–°ç§å­çŠ¶æ€
                if (data.seed) state.seed = data.seed;

                // é¢„åŠ è½½
                const temp = new Image();
                temp.src = src;
                temp.onload = () => {
                    img.src = src;
                    img.classList.remove('hidden');
                    loader.classList.add('hidden');
                    actions.classList.remove('hidden'); // æ˜¾ç¤ºä¸‹è½½/é”å®šæŒ‰é’®
                    
                    // å¦‚æœå·²ç»é”å®šäº†ï¼Œå°±ä¸æ˜¾ç¤ºé”å®šæŒ‰é’®
                    document.getElementById('refineBtn').classList.toggle('hidden', !!state.lockedSeed);
                    
                    btn.disabled = false; btn.classList.remove('opacity-50'); btnText.innerText = "å¼€å§‹ç”Ÿæˆ";
                };
                temp.onerror = () => { throw new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"); }

            } catch (e) {
                alert("ç”Ÿæˆå¤±è´¥: " + e.message);
                loader.classList.add('hidden');
                btn.disabled = false; btn.classList.remove('opacity-50'); btnText.innerText = "å¼€å§‹ç”Ÿæˆ";
            }
        }

        function downloadImg() {
            const a = document.createElement('a');
            a.href = document.getElementById('resultImg').src;
            a.download = `AI-Art-${Date.now()}.png`;
            a.click();
        }

        init();
    </script>
</body>
</html>


