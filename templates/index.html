<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒæ¬¡å…ƒç»˜å›¾æœº Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); }
        .active-tab { background: #6366f1; color: white; }
        .loader { width: 32px; height: 32px; border: 3px solid #475569; border-top-color: #818cf8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        /* é®ç½©åŠ¨ç”» */
        #settingsModal { transition: opacity 0.3s; pointer-events: none; opacity: 0; }
        #settingsModal.show { pointer-events: auto; opacity: 1; }
    </style>
</head>
<body class="min-h-screen flex justify-center p-4">

    <div class="max-w-md w-full space-y-4">
        <!-- é¡¶éƒ¨ -->
        <header class="flex justify-between items-center py-2">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-indigo-600 rounded-lg shadow-lg"><i data-lucide="zap" class="text-white w-5 h-5"></i></div>
                <div>
                    <h1 class="font-bold text-lg leading-none">äºŒæ¬¡å…ƒç»˜å›¾æœº</h1>
                    <p class="text-[10px] text-slate-400 font-mono" id="engineLabel">Engine: Free Guest</p>
                </div>
            </div>
            <button onclick="toggleSettings()" class="p-2 bg-slate-800 rounded-lg text-slate-400"><i data-lucide="settings-2" class="w-5 h-5"></i></button>
        </header>

        <!-- æ¨¡å¼ -->
        <div class="flex bg-slate-800/80 p-1 rounded-xl">
            <button onclick="setMode('txt2img')" id="btn-txt2img" class="flex-1 py-2.5 text-xs font-bold rounded-lg active-tab transition-all">çµæ„Ÿç»˜å›¾</button>
            <button onclick="setMode('lineart')" id="btn-lineart" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 transition-all">çº¿ç¨¿æå–</button>
            <button onclick="setMode('colorize')" id="btn-colorize" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 transition-all">é…è‰²</button>
        </div>

        <!-- è¾“å…¥æ¡† -->
        <div class="glass p-3 rounded-2xl">
            <textarea id="prompt" class="w-full h-28 bg-transparent resize-none outline-none text-sm placeholder-slate-600 text-slate-200" placeholder="æè¿°ç”»é¢ (ä¾‹å¦‚: é“¶å‘å°‘å¥³, èµ›åšæœ‹å…‹)..."></textarea>
        </div>

        <!-- æŒ‰é’® -->
        <button onclick="generate()" id="genBtn" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all">
            <i data-lucide="play" class="w-4 h-4 fill-current"></i> å¼€å§‹ç”Ÿæˆ
        </button>

        <!-- ç»“æœ -->
        <div id="resultBox" class="glass rounded-2xl min-h-[350px] flex items-center justify-center relative bg-slate-900/30 overflow-hidden">
            <div id="placeholder" class="text-center text-slate-600">
                <i data-lucide="image" class="w-10 h-10 mx-auto mb-2 opacity-20"></i>
                <span class="text-xs opacity-50">ç”»å¸ƒå‡†å¤‡å°±ç»ª</span>
            </div>
            <div id="loader" class="hidden flex flex-col items-center">
                <div class="loader mb-3"></div>
                <span class="text-xs text-indigo-400 animate-pulse tracking-widest">AI æ­£åœ¨ç»˜åˆ¶...</span>
            </div>
            <img id="resultImg" class="hidden w-full h-full object-contain shadow-2xl relative z-10 bg-slate-900" onload="this.style.opacity=1">
            <button id="dlBtn" onclick="downloadImg()" class="hidden absolute bottom-4 bg-white text-slate-900 px-6 py-2 rounded-full font-bold text-xs shadow-xl z-20 flex items-center gap-2">
                <i data-lucide="download" class="w-3 h-3"></i> ä¿å­˜
            </button>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm p-6">
        <div class="glass w-full max-w-sm p-6 rounded-2xl">
            <h2 class="text-lg font-bold mb-4">é…ç½®å¼•æ“</h2>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-slate-400">é€‰æ‹©æä¾›å•†</label>
                    <select id="providerSelect" onchange="toggleKeyInput()" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm mt-1 outline-none">
                        <option value="guest">ğŸ æ¸¸å®¢å…è´¹æ¨¡å¼ (æ¨è)</option>
                        <option value="openai">ğŸ¤– OpenAI (éœ€è¦ Key)</option>
                    </select>
                </div>
                <div id="keyInputBox" class="hidden">
                    <label class="text-xs text-slate-400">API Key</label>
                    <input type="password" id="userKey" placeholder="sk-..." class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm mt-1 outline-none font-mono">
                </div>
                <button onclick="saveSettings()" class="w-full bg-indigo-600 py-2 rounded-lg font-bold mt-4">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let state = { mode: 'txt2img', provider: 'guest', key: '' };
        function init() { lucide.createIcons(); }

        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('show');
        }

        function toggleKeyInput() {
            const val = document.getElementById('providerSelect').value;
            document.getElementById('keyInputBox').classList.toggle('hidden', val === 'guest');
        }

        function saveSettings() {
            state.provider = document.getElementById('providerSelect').value;
            state.key = document.getElementById('userKey').value;
            document.getElementById('engineLabel').innerText = `Engine: ${state.provider === 'guest' ? 'Free Guest' : 'OpenAI'}`;
            toggleSettings();
        }

        function setMode(m) {
            state.mode = m;
            document.querySelectorAll('button[id^="btn-"]').forEach(b => {
                b.classList.remove('active-tab', 'text-white');
                b.classList.add('text-slate-400');
            });
            document.getElementById('btn-' + m).classList.add('active-tab', 'text-white');
            document.getElementById('btn-' + m).classList.remove('text-slate-400');
            
            const hints = { txt2img: "æè¿°ç”»é¢...", lineart: "æè¿°çº¿ç¨¿å†…å®¹...", colorize: "æè¿°é…è‰²...", redraw: "æè¿°é‡ç»˜é£æ ¼..." };
            document.getElementById('prompt').placeholder = hints[m];
        }

        async function generate() {
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) return alert("è¯·è¾“å…¥æè¿°è¯ï¼");

            const btn = document.getElementById('genBtn');
            btn.disabled = true; btn.classList.add('opacity-50');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('resultImg').classList.add('hidden');
            document.getElementById('dlBtn').classList.add('hidden');

            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: state.provider,
                        mode: state.mode,
                        prompt: prompt,
                        api_key: state.key
                    })
                });
                
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                
                const img = document.getElementById('resultImg');
                // Pollinations è¿”å› URLï¼ŒOpenAI è¿”å› Base64
                if (data.image_url) img.src = data.image_url;
                else img.src = "data:image/png;base64," + data.image_b64;
                
                img.onload = () => {
                    img.classList.remove('hidden');
                    document.getElementById('dlBtn').classList.remove('hidden');
                    document.getElementById('loader').classList.add('hidden');
                };
            } catch (e) {
                alert("ç”Ÿæˆå¤±è´¥: " + e.message);
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('placeholder').classList.remove('hidden');
            } finally {
                btn.disabled = false; btn.classList.remove('opacity-50');
            }
        }

        function downloadImg() {
            const a = document.createElement('a');
            a.href = document.getElementById('resultImg').src;
            a.download = `anime-${Date.now()}.png`;
            a.click();
        }

        init();
    </script>
</body>
</html>


