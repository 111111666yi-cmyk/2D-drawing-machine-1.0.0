<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒæ¬¡å…ƒç»˜å›¾æœº (äº‘ç«¯ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); }
        .active-tab { background: #6366f1; color: white; }
        .loader { width: 32px; height: 32px; border: 3px solid #475569; border-top-color: #818cf8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        select { background-color: #1e293b; border: 1px solid #334155; color: #cbd5e1; padding: 4px 8px; border-radius: 6px; outline: none; font-size: 12px; }
    </style>
</head>
<body class="min-h-screen flex justify-center p-4">

    <div class="max-w-md w-full space-y-4">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="flex items-center justify-between py-2">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-indigo-600 rounded-lg shadow-lg shadow-indigo-500/30">
                    <i data-lucide="zap" class="text-white w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-none">äºŒæ¬¡å…ƒç»˜å›¾æœº</h1>
                    <p class="text-[10px] text-slate-400 font-mono">Cloud Engine v2.0</p>
                </div>
            </div>
            
            <!-- æ¨¡å‹é€‰æ‹©å™¨ -->
            <div class="flex flex-col items-end">
                <label class="text-[10px] text-slate-500 mb-1">AI æ¨¡å‹æº</label>
                <select id="providerSelect">
                    <option value="google">â˜ï¸ Google Gemini</option>
                    <option value="openai">ğŸ¤– OpenAI DALL-E</option>
                </select>
            </div>
        </header>

        <!-- åŠŸèƒ½æ¨¡å¼ -->
        <div class="flex bg-slate-800/80 p-1 rounded-xl">
            <button onclick="setMode('txt2img')" id="btn-txt2img" class="flex-1 py-2.5 text-xs font-bold rounded-lg active-tab transition-all">çµæ„Ÿç»˜å›¾</button>
            <button onclick="setMode('colorize')" id="btn-colorize" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 transition-all">è‡ªåŠ¨ä¸Šè‰²</button>
            <button onclick="setMode('lineart')" id="btn-lineart" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 transition-all">çº¿ç¨¿æå–</button>
            <button onclick="setMode('redraw')" id="btn-redraw" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 transition-all">é£æ ¼é‡ç»˜</button>
        </div>

        <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ (è‡ªåŠ¨æ˜¾éš) -->
        <div id="uploadArea" class="hidden glass p-4 rounded-2xl border-dashed border-2 border-slate-600/50">
            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFile(this)">
            
            <div id="uploadPlaceholder" onclick="document.getElementById('fileInput').click()" class="flex flex-col items-center justify-center h-28 text-slate-400 cursor-pointer hover:text-indigo-400 transition-colors">
                <i data-lucide="image-plus" class="w-8 h-8 mb-2 opacity-50"></i>
                <span class="text-xs">ç‚¹å‡»ä¸Šä¼ å‚è€ƒåº•å›¾</span>
            </div>
            
            <div id="previewBox" class="hidden relative">
                <img id="previewImg" class="h-40 w-full object-contain rounded-lg bg-slate-900/50">
                <button onclick="clearFile()" class="absolute top-2 right-2 bg-black/60 text-white p-1.5 rounded-full hover:bg-red-500 transition-colors">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- æç¤ºè¯è¾“å…¥ -->
        <div class="glass p-3 rounded-2xl relative group">
            <textarea id="prompt" class="w-full h-28 bg-transparent resize-none outline-none text-sm placeholder-slate-600 text-slate-200" placeholder="åœ¨æ­¤è¾“å…¥ç”»é¢æè¿°..."></textarea>
            <div class="absolute bottom-2 right-2 text-[10px] text-slate-600 font-mono">PROMPT</div>
        </div>

        <!-- ç”ŸæˆæŒ‰é’® -->
        <button onclick="generate()" id="genBtn" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-2xl font-bold shadow-lg shadow-indigo-900/40 flex items-center justify-center gap-2 active:scale-95 transition-all">
            <i data-lucide="play" class="w-4 h-4 fill-current"></i> å¼€å§‹ç”Ÿæˆ
        </button>

        <!-- ç»“æœå±•ç¤ºåŒº -->
        <div id="resultBox" class="glass rounded-2xl min-h-[350px] flex items-center justify-center relative bg-slate-900/30 overflow-hidden">
            <!-- åˆå§‹çŠ¶æ€ -->
            <div id="placeholder" class="text-center text-slate-600">
                <i data-lucide="image" class="w-10 h-10 mx-auto mb-2 opacity-20"></i>
                <span class="text-xs opacity-50">ç”»å¸ƒå‡†å¤‡å°±ç»ª</span>
            </div>
            
            <!-- åŠ è½½ä¸­ -->
            <div id="loader" class="hidden flex flex-col items-center">
                <div class="loader mb-3"></div>
                <span class="text-xs text-indigo-400 animate-pulse tracking-widest">æ­£åœ¨äº‘ç«¯æ¸²æŸ“...</span>
            </div>
            
            <!-- ç»“æœå›¾ç‰‡ -->
            <img id="resultImg" class="hidden max-w-full max-h-full object-contain shadow-2xl relative z-10 transition-opacity duration-500 opacity-0" onload="this.style.opacity=1">
            
            <!-- ä¸‹è½½æŒ‰é’® -->
            <button id="dlBtn" onclick="downloadImg()" class="hidden absolute bottom-4 bg-white text-slate-900 px-6 py-2 rounded-full font-bold text-xs shadow-xl hover:scale-105 transition-transform flex items-center gap-2 z-20">
                <i data-lucide="download" class="w-3 h-3"></i> ä¿å­˜å›¾ç‰‡
            </button>
        </div>
    </div>

    <!-- é”™è¯¯æç¤ºæ¡ -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-800 border border-slate-700 text-white px-4 py-3 rounded-full text-xs shadow-2xl hidden z-50 flex items-center gap-2"></div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        let state = { mode: 'txt2img', image: null };
        function init() { lucide.createIcons(); }

        // åˆ‡æ¢æ¨¡å¼
        function setMode(m) {
            state.mode = m;
            document.querySelectorAll('button[id^="btn-"]').forEach(b => {
                b.classList.remove('active-tab', 'text-white');
                b.classList.add('text-slate-400');
            });
            document.getElementById('btn-' + m).classList.add('active-tab', 'text-white');
            document.getElementById('btn-' + m).classList.remove('text-slate-400');
            
            // åªæœ‰çµæ„Ÿç»˜å›¾ä¸éœ€è¦ä¸Šä¼ å›¾ç‰‡
            document.getElementById('uploadArea').classList.toggle('hidden', m === 'txt2img');
            
            // æ›´æ–°æç¤ºæ–‡æœ¬
            const hints = {
                txt2img: "æè¿°ç”»é¢ (ä¾‹å¦‚: é“¶å‘å°‘å¥³, èµ›åšæœ‹å…‹)...",
                lineart: "ä¸éœ€è¦è¾“å…¥æè¿°ï¼Œç‚¹å‡»ç”Ÿæˆå³å¯æå–çº¿ç¨¿...",
                colorize: "æè¿°é…è‰²æ–¹æ¡ˆ (ä¾‹å¦‚: æš–è‰²è°ƒ, è“è‰²çœ¼ç›)...",
                redraw: "æè¿°é‡ç»˜åçš„ç»†èŠ‚..."
            };
            document.getElementById('prompt').placeholder = hints[m];
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                state.image = e.target.result.split(',')[1];
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('previewBox').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearFile() {
            state.image = null;
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('previewBox').classList.add('hidden');
            document.getElementById('fileInput').value = '';
        }

        // å‘é€è¯·æ±‚ç»™åç«¯
        async function generate() {
            const prompt = document.getElementById('prompt').value.trim();
            const provider = document.getElementById('providerSelect').value;

            // æ ¡éªŒ
            if (state.mode !== 'txt2img' && !state.image) return showToast("âš ï¸ è¯·å…ˆä¸Šä¼ åº•å›¾ï¼");
            
            // é”å®šç•Œé¢
            const btn = document.getElementById('genBtn');
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('resultImg').classList.add('hidden');
            document.getElementById('dlBtn').classList.add('hidden');

            try {
                // å‘é€ç»™ main.py (POST /api/generate)
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: provider, // å‘Šè¯‰åç«¯ç”¨å“ªä¸ªæ¨¡å‹
                        mode: state.mode,
                        prompt: prompt,
                        image: state.image
                    })
                });
                
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);
                
                // æ˜¾ç¤ºç»“æœ
                const img = document.getElementById('resultImg');
                img.src = "data:image/png;base64," + data.image;
                img.classList.remove('hidden');
                document.getElementById('dlBtn').classList.remove('hidden');

            } catch (e) {
                showToast("âŒ " + e.message);
                document.getElementById('placeholder').classList.remove('hidden');
            } finally {
                document.getElementById('loader').classList.add('hidden');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function downloadImg() {
            const a = document.createElement('a');
            a.href = document.getElementById('resultImg').src;
            a.download = `anime-art-${Date.now()}.png`;
            a.click();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 4000);
        }

        init();
    </script>
</body>
</html>
