<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒæ¬¡å…ƒç»˜å›¾æœº 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .active-tab { background: #6366f1; color: white; }
        .loader { width: 36px; height: 36px; border: 3px solid #334155; border-top-color: #818cf8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen flex justify-center p-4">

    <div class="max-w-md w-full space-y-4">
        <!-- å¤´éƒ¨ -->
        <header class="flex justify-between items-center py-2">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-indigo-600 rounded-lg shadow-lg"><i data-lucide="zap" class="text-white w-5 h-5"></i></div>
                <div>
                    <h1 class="font-bold text-lg leading-none">äºŒæ¬¡å…ƒç»˜å›¾æœº</h1>
                    <p class="text-[10px] text-slate-400 font-mono">Secure Cloud v2.0</p>
                </div>
            </div>
            <button onclick="toggleSettings()" class="p-2 bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors">
                <i data-lucide="settings-2" class="w-5 h-5"></i>
            </button>
        </header>

        <!-- æ¨¡å¼ Tabs -->
        <div class="flex bg-slate-800/80 p-1 rounded-xl overflow-x-auto no-scrollbar">
            <button onclick="setMode('txt2img')" id="btn-txt2img" class="flex-1 py-2.5 text-xs font-bold rounded-lg active-tab transition-all min-w-[80px]">çµæ„Ÿç»˜å›¾</button>
            <button onclick="setMode('colorize')" id="btn-colorize" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 transition-all min-w-[80px]">è‡ªåŠ¨ä¸Šè‰²</button>
            <button onclick="setMode('lineart')" id="btn-lineart" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 transition-all min-w-[80px]">çº¿ç¨¿æå–</button>
            <button onclick="setMode('redraw')" id="btn-redraw" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 transition-all min-w-[80px]">é£æ ¼é‡ç»˜</button>
        </div>

        <!-- å›¾ç‰‡ä¸Šä¼  -->
        <div id="uploadArea" class="hidden glass p-4 rounded-2xl border-dashed border-2 border-slate-600/50">
            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFile(this)">
            <div id="uploadPlaceholder" onclick="document.getElementById('fileInput').click()" class="flex flex-col items-center justify-center h-24 text-slate-400 cursor-pointer">
                <i data-lucide="image-plus" class="mb-2 opacity-70"></i>
                <span class="text-xs">ç‚¹å‡»ä¸Šä¼ åº•å›¾</span>
            </div>
            <div id="previewBox" class="hidden relative">
                <img id="previewImg" class="h-32 w-full object-contain rounded-lg bg-slate-900/50">
                <button onclick="clearFile()" class="absolute top-1 right-1 bg-black/60 text-white p-1.5 rounded-full"><i data-lucide="x" class="w-3 h-3"></i></button>
            </div>
        </div>

        <!-- æè¿°è¯ -->
        <div class="glass p-3 rounded-2xl">
            <textarea id="prompt" class="w-full h-24 bg-transparent resize-none outline-none text-sm placeholder-slate-600 text-slate-200" placeholder="æè¿°ç”»é¢..."></textarea>
        </div>

        <!-- æŒ‰é’® -->
        <button onclick="generate()" id="genBtn" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all">
            <i data-lucide="play" class="w-4 h-4 fill-current"></i> å¼€å§‹ç”Ÿæˆ
        </button>

        <!-- ç»“æœåŒº -->
        <div id="resultBox" class="glass rounded-2xl min-h-[300px] flex items-center justify-center relative bg-slate-900/30 overflow-hidden">
            <div id="placeholder" class="text-center text-slate-600">
                <i data-lucide="image" class="w-8 h-8 mx-auto mb-2 opacity-30"></i>
                <span class="text-xs opacity-50">ç”»å¸ƒå‡†å¤‡å°±ç»ª</span>
            </div>
            <div id="loader" class="hidden flex flex-col items-center">
                <div class="loader mb-2"></div>
                <span class="text-xs text-indigo-400 animate-pulse tracking-widest">AI æ­£åœ¨ç»˜åˆ¶...</span>
            </div>
            <img id="resultImg" class="hidden max-w-full max-h-full object-contain shadow-2xl relative z-10">
            <button id="dlBtn" onclick="downloadImg()" class="hidden absolute bottom-4 bg-white text-slate-900 px-5 py-2 rounded-full font-bold text-xs shadow-xl z-20 flex items-center gap-1">
                <i data-lucide="download" class="w-3 h-3"></i> ä¿å­˜
            </button>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden backdrop-blur-sm p-4">
        <div class="glass w-full max-w-xs p-6 rounded-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">å¼•æ“é…ç½®</h2>
                <button onclick="toggleSettings()"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 block mb-1">é€‰æ‹©å¼•æ“</label>
                    <select id="providerSelect" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none">
                        <option value="server_google">ğŸ æ¸¸å®¢æ¨¡å¼ (Google Gemini)</option>
                        <option value="server_openai">ğŸ æ¸¸å®¢æ¨¡å¼ (OpenAI)</option>
                        <option value="custom_google">âš™ï¸ è‡ªå®šä¹‰ Key (Google)</option>
                        <option value="custom_openai">âš™ï¸ è‡ªå®šä¹‰ Key (OpenAI)</option>
                    </select>
                </div>
                <div id="customKeyBox" class="hidden">
                    <label class="text-xs text-slate-400 block mb-1">è‡ªå®šä¹‰ API Key</label>
                    <input type="password" id="customKeyInput" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none font-mono" placeholder="sk-..." />
                </div>
                <button onclick="saveSettings()" class="w-full bg-indigo-600 py-2 rounded-lg font-bold text-sm">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <script>
        let state = { mode: 'txt2img', image: null };
        let config = { provider: 'server_google', key: '' };

        function init() { 
            lucide.createIcons();
            const saved = localStorage.getItem('ANIME_CONFIG');
            if(saved) {
                config = JSON.parse(saved);
                document.getElementById('providerSelect').value = config.provider;
                document.getElementById('customKeyInput').value = config.key;
            }
            handleProviderChange();
        }

        // è®¾ç½®é€»è¾‘
        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('hidden');
        }
        
        document.getElementById('providerSelect').addEventListener('change', handleProviderChange);
        
        function handleProviderChange() {
            const val = document.getElementById('providerSelect').value;
            document.getElementById('customKeyBox').classList.toggle('hidden', !val.startsWith('custom'));
        }

        function saveSettings() {
            config.provider = document.getElementById('providerSelect').value;
            config.key = document.getElementById('customKeyInput').value;
            localStorage.setItem('ANIME_CONFIG', JSON.stringify(config));
            toggleSettings();
            alert("é…ç½®å·²ä¿å­˜ï¼");
        }

        // æ¨¡å¼åˆ‡æ¢
        function setMode(m) {
            state.mode = m;
            document.querySelectorAll('button[id^="btn-"]').forEach(b => {
                b.classList.remove('active-tab', 'text-white');
                b.classList.add('text-slate-400');
            });
            document.getElementById('btn-' + m).classList.add('active-tab', 'text-white');
            document.getElementById('btn-' + m).classList.remove('text-slate-400');
            document.getElementById('uploadArea').classList.toggle('hidden', m === 'txt2img');
            
            const hints = { txt2img: "æè¿°ç”»é¢...", colorize: "æè¿°é…è‰²...", lineart: "ç›´æ¥ç‚¹å‡»ç”Ÿæˆ...", redraw: "æè¿°é£æ ¼..." };
            document.getElementById('prompt').placeholder = hints[m];
        }

        // æ–‡ä»¶å¤„ç†
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                state.image = e.target.result.split(',')[1];
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('previewBox').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
        function clearFile() {
            state.image = null;
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('previewBox').classList.add('hidden');
            document.getElementById('fileInput').value = '';
        }

        // ç”Ÿæˆé€»è¾‘
        async function generate() {
            const prompt = document.getElementById('prompt').value.trim();
            if (state.mode !== 'txt2img' && !state.image) return alert("è¯·ä¸Šä¼ åº•å›¾");

            // UI é”å®š
            const btn = document.getElementById('genBtn');
            btn.disabled = true; btn.classList.add('opacity-50');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('resultImg').classList.add('hidden');
            document.getElementById('dlBtn').classList.add('hidden');

            try {
                // å‘é€ç»™åç«¯
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: config.provider,
                        api_key: config.provider.startsWith('custom') ? config.key : null,
                        mode: state.mode,
                        prompt: prompt,
                        image: state.image
                    })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error);

                document.getElementById('resultImg').src = "data:image/png;base64," + data.image;
                document.getElementById('resultImg').classList.remove('hidden');
                document.getElementById('dlBtn').classList.remove('hidden');

            } catch (e) {
                alert("ç”Ÿæˆå¤±è´¥: " + e.message);
                document.getElementById('placeholder').classList.remove('hidden');
            } finally {
                document.getElementById('loader').classList.add('hidden');
                btn.disabled = false; btn.classList.remove('opacity-50');
            }
        }

        function downloadImg() {
            const a = document.createElement('a');
            a.href = document.getElementById('resultImg').src;
            a.download = `anime-${Date.now()}.png`;
            a.click();
        }

        init();
    </script>
</body>
</html>


