<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒæ¬¡å…ƒç»˜å›¾æœº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); }
        .active-tab { background: #6366f1; color: white; }
        .loader { width: 32px; height: 32px; border: 3px solid #475569; border-top-color: #818cf8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        /* éšè—æ»šåŠ¨æ¡ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        select { background-color: #1e293b; border: 1px solid #334155; color: #cbd5e1; padding: 4px 8px; border-radius: 6px; outline: none; font-size: 12px; }
    </style>
</head>
<body class="min-h-screen flex justify-center p-4">

    <div class="max-w-md w-full space-y-4">
        <!-- é¡¶éƒ¨ -->
        <header class="flex justify-between items-center py-2">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-indigo-600 rounded-lg shadow-lg"><i data-lucide="zap" class="text-white w-5 h-5"></i></div>
                <div>
                    <h1 class="font-bold text-lg leading-none">äºŒæ¬¡å…ƒç»˜å›¾æœº</h1>
                    <p class="text-[10px] text-slate-400 font-mono">Status: Online</p>
                </div>
            </div>
            
            <div class="flex flex-col items-end gap-1">
                <select id="providerSelect" onchange="toggleKeyInput()">
                    <option value="guest">ğŸ æ¸¸å®¢æ¨¡å¼ (å…è´¹/å…Key)</option>
                    <option value="google">â˜ï¸ Google Gemini</option>
                    <option value="openai">ğŸ¤– OpenAI DALL-E</option>
                </select>
                <input id="userKey" type="password" class="hidden w-32 bg-slate-800 border border-slate-700 text-[10px] rounded px-2 py-1 outline-none placeholder-slate-500" placeholder="åœ¨æ­¤å¡«å…¥ Key">
            </div>
        </header>

        <!-- æ¨¡å¼ -->
        <div class="flex bg-slate-800/80 p-1 rounded-xl overflow-x-auto no-scrollbar">
            <button onclick="setMode('txt2img')" id="btn-txt2img" class="flex-1 py-2.5 text-xs font-bold rounded-lg active-tab transition-all min-w-[80px]">çµæ„Ÿç»˜å›¾</button>
            <button onclick="setMode('colorize')" id="btn-colorize" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 transition-all min-w-[80px]">è‡ªåŠ¨ä¸Šè‰²</button>
            <button onclick="setMode('lineart')" id="btn-lineart" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-400 transition-all min-w-[80px]">çº¿ç¨¿æå–</button>
        </div>

        <!-- å›¾ç‰‡ä¸Šä¼  -->
        <div id="uploadArea" class="hidden glass p-4 rounded-2xl border-dashed border-2 border-slate-600/50">
            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFile(this)">
            <div id="uploadPlaceholder" onclick="document.getElementById('fileInput').click()" class="flex flex-col items-center justify-center h-24 text-slate-400 cursor-pointer">
                <i data-lucide="image-plus" class="mb-2"></i>
                <span class="text-xs">ç‚¹å‡»ä¸Šä¼ åº•å›¾</span>
            </div>
            <div id="previewBox" class="hidden relative">
                <img id="previewImg" class="h-32 w-full object-contain rounded-lg">
                <button onclick="clearFile()" class="absolute top-1 right-1 bg-black/60 text-white p-1 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
        </div>

        <!-- è¾“å…¥æ¡† -->
        <div class="glass p-3 rounded-2xl">
            <textarea id="prompt" class="w-full h-24 bg-transparent resize-none outline-none text-sm placeholder-slate-600 text-slate-200" placeholder="æè¿°ç”»é¢..."></textarea>
        </div>

        <!-- æŒ‰é’® -->
        <button onclick="generate()" id="genBtn" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all">
            <i data-lucide="play" class="w-4 h-4 fill-current"></i> å¼€å§‹ç”Ÿæˆ
        </button>

        <!-- ç»“æœ -->
        <div id="resultBox" class="glass rounded-2xl min-h-[300px] flex items-center justify-center relative bg-slate-900/30 overflow-hidden">
            <div id="placeholder" class="text-center text-slate-600">
                <i data-lucide="image" class="w-10 h-10 mx-auto mb-2 opacity-20"></i>
                <span class="text-xs opacity-50">ç”»å¸ƒå‡†å¤‡å°±ç»ª</span>
            </div>
            <div id="loader" class="hidden flex flex-col items-center">
                <div class="loader mb-2"></div>
                <span class="text-xs text-indigo-400 animate-pulse">æ­£åœ¨ç»˜åˆ¶...</span>
            </div>
            <img id="resultImg" class="hidden max-w-full max-h-full object-contain shadow-2xl relative z-10">
            <button id="dlBtn" onclick="downloadImg()" class="hidden absolute bottom-4 bg-white text-slate-900 px-6 py-2 rounded-full font-bold text-xs shadow-xl z-20">ä¿å­˜</button>
        </div>
    </div>

    <script>
        let state = { mode: 'txt2img', image: null };
        function init() { lucide.createIcons(); }

        function toggleKeyInput() {
            const val = document.getElementById('providerSelect').value;
            const input = document.getElementById('userKey');
            if (val === 'guest') input.classList.add('hidden');
            else input.classList.remove('hidden');
        }

        function setMode(m) {
            state.mode = m;
            document.querySelectorAll('button[id^="btn-"]').forEach(b => {
                b.classList.remove('active-tab', 'text-white');
                b.classList.add('text-slate-400');
            });
            document.getElementById('btn-' + m).classList.add('active-tab', 'text-white');
            document.getElementById('btn-' + m).classList.remove('text-slate-400');
            document.getElementById('uploadArea').classList.toggle('hidden', m === 'txt2img');
        }

        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                state.image = e.target.result.split(',')[1];
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('previewBox').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearFile() {
            state.image = null;
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('previewBox').classList.add('hidden');
            document.getElementById('fileInput').value = '';
        }

        async function generate() {
            const prompt = document.getElementById('prompt').value.trim();
            const provider = document.getElementById('providerSelect').value;
            const userKey = document.getElementById('userKey').value.trim();

            if (state.mode !== 'txt2img' && !state.image) return alert("è¯·å…ˆä¸Šä¼ åº•å›¾ï¼");
            
            const btn = document.getElementById('genBtn');
            btn.disabled = true; btn.classList.add('opacity-50');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('resultImg').classList.add('hidden');
            document.getElementById('dlBtn').classList.add('hidden');

            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: provider,
                        mode: state.mode,
                        prompt: prompt,
                        image: state.image,
                        api_key: userKey
                    })
                });
                
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                
                const img = document.getElementById('resultImg');
                if (data.image_url) img.src = data.image_url; // æ¸¸å®¢æ¨¡å¼è¿”å› URL
                else img.src = "data:image/png;base64," + data.image_b64; // å…¶ä»–æ¨¡å¼è¿”å› Base64
                
                img.onload = () => {
                    img.classList.remove('hidden');
                    document.getElementById('dlBtn').classList.remove('hidden');
                    document.getElementById('loader').classList.add('hidden');
                };
            } catch (e) {
                alert("å‡ºé”™å•¦: " + e.message);
                document.getElementById('placeholder').classList.remove('hidden');
                document.getElementById('loader').classList.add('hidden');
            } finally {
                btn.disabled = false; btn.classList.remove('opacity-50');
            }
        }

        function downloadImg() {
            const a = document.createElement('a');
            a.href = document.getElementById('resultImg').src;
            a.download = `anime-${Date.now()}.png`;
            a.click();
        }

        init();
    </script>
</body>
</html>


